function ready(t,e){if(t)return console.error(t);var a=topojson.feature(e,e.objects.countries);projection.scale(1).translate([0,0]);var r=path.bounds(a),i=.95/Math.max((r[1][0]-r[0][0])/width,(r[1][1]-r[0][1])/height),n=[(width-i*(r[1][0]+r[0][0]))/2,(height-i*(r[1][1]+r[0][1]))/2];projection.scale(i).translate(n),g.append("g").attr("class","land").selectAll("path").data(a.features).enter().append("path").attr("d",path).style("fill",function(t){return migrated(t.id)}),g.append("path").datum(topojson.mesh(e,e.objects.countries,function(t,e){return t!==e})).attr("class","border").attr("d",path);var o=g.selectAll("text").data(migratedCountry).enter();o.append("text").text(function(t){return t.country}).attr("x",function(t){return projection([deathById.get(t.id).Longitude,deathById.get(t.id).Latitude])[0]-2}).attr("y",function(t){return projection([deathById.get(t.id).Longitude,deathById.get(t.id).Latitude])[1]-7}).attr("font-family","'Helvetica Neue', Helvetica, sans-serif").attr("font-size","9px").attr("font-weight","600").attr("fill","#333").attr("fill-opacity",".8");var d=svg.append("g").attr("class","legend").attr("transform","translate(820,"+(height-150)+")").selectAll("g").data([50,500,1e3]).enter().append("g");d.append("circle").attr("cy",function(t){return-radius(t)}).attr("r",radius),d.append("text").attr("y",function(t){return-2*radius(t)}).attr("dy","1.3em").text(d3.format(".1")),arcHandler(),renderBubbles(),renderBars(),d3.selectAll("#metrics li").on("click",function(){var t=d3.select(this);0==t.classed("selected")&&(d3.selectAll("#metrics li").classed("selected",function(){return!1}),t.classed("selected "+t.attr("data-metric"),!0),CURR_SELECT[0]=t.attr("data-metric")+"_Total",g.selectAll("circle").remove(),deathType="All Deaths"!=t.text()?"from "+t.text()+"s":"in total",bubbleDelay=200,CURR_BAR[0]="All Deaths"==t.text()?"Total":t.attr("data-metric"),renderBubbles(),renderBars())}),svg.select("#progress-image").remove()}function setColumns(t){t.Longitude=+t.Longitude,t.Latitude=+t.Latitude,t.Country_Total=+t.Country_Total,t.Total_067_068=+t.Total_067_068,t.Total_068_069=+t.Total_068_069,t.Total_069_070=+t.Total_069_070,t.Total_070_071=+t.Total_070_071,t.Total_071_071=+t.Total_071_071,t.Suicide_Total=+t.Suicide_Total,t.CardiacArrest_Total=+t.CardiacArrest_Total,t.NaturalDeath_Total=+t.NaturalDeath_Total,t.HeartAttack_Total=+t.HeartAttack_Total,t.Murder_Total=+t.Murder_Total,t.WorkplaceAccident_Total=+t.WorkplaceAccident_Total,t.Other_Total=+t.Other_Total,deathById.set(t.Country,t)}function migrated(t){var e=["NPL","MYS","KOR","JPN","AFG","QAT","SAU","BHR","ARE","KWT","ISR","LBN","OMN"],a=e.indexOf(t);return 0==a?"#6d6760":a>0?"#b7ada0":"#E5D9C9"}function renderBars(){var t=[deathById.get("All")[CURR_BAR[0]+"_067_068"],deathById.get("All")[CURR_BAR[0]+"_068_069"],deathById.get("All")[CURR_BAR[0]+"_069_070"],deathById.get("All")[CURR_BAR[0]+"_070_071"],deathById.get("All")[CURR_BAR[0]+"_071_071"]],e=[deathById.get("All")[CURR_BAR[0]+"_071_071_Forecast"]],a=g.selectAll(".predictbar").data(e);a.exit().remove(),a.enter().append("rect").attr("class","predictbar"),a.attr("x",330).attr("y",height-190).attr("width",20).attr("height",0).transition().delay(bubbleDelay+1e3).duration(1200).ease("linear").attr("height",function(t){return t/8});var r=g.selectAll(".predictlabel").data(e);r.exit().remove(),r.enter().append("text").attr("class","predictlabel"),r.text(function(t){return"** "+t+" deaths estimated this period"}).attr("x",355).attr("y",function(t){return height-190+t/8+5}).style("opacity",0).transition().delay(bubbleDelay+2e3).duration(2e3).ease("linear").style("opacity",.8);var i=g.selectAll(".bar").data(t);i.exit().remove(),i.enter().append("rect").attr("class","bar"),i.attr("x",function(t,e){return 25*e+230}).attr("y",height-190).attr("width",20).attr("height",0).transition().delay(bubbleDelay).duration(1200).ease("linear").attr("height",function(t){return t/8});var n=g.selectAll(".barlabel").data(t);n.exit().remove(),n.enter().append("text").attr("class","barlabel"),n.text(function(t){return t}).attr("x",function(t,e){return 25*e+231}).attr("y",function(t){return height-190+t/8+10}).attr("font-family","sans-serif").attr("font-size","9px").attr("fill","darkgray").style("opacity",0).transition().delay(bubbleDelay+500).duration(1500).ease("linear").style("opacity",.9);var o=g.selectAll(".yearlabel").data(t);o.exit().remove(),o.enter().append("text").text("Five Year Trend").attr("x",245).attr("y",height-230).attr("font-family","'Helvetica Neue', Helvetica, sans-serif").attr("font-size","14px").attr("font-weight","400").attr("fill","#333"),o.enter().append("text").attr("class","yearlabel"),o.text(function(t,e){return years[e]}).attr("x",function(t,e){return 25*e+230}).attr("y",height-190).attr("transform",function(t,e){return"rotate(-35,"+(25*e+225)+","+(height-205)+")"});var d=g.selectAll(".kpilabel").data(CURR_SELECT);d.exit().remove(),d.enter().append("text").attr("class","kpilabel"),d.text(function(t){return deathById.get("All")[t]}).attr("x",420).attr("y",55).attr("opacity",0).transition().delay(bubbleDelay+1e3).duration(2500).ease("cube").style("opacity",.8),d.enter().append("text").text("lives lost").attr("x",425).attr("y",74).attr("font-family","Helvetica, sans-serif").attr("font-size","14px").attr("font-weight","400").attr("fill","#777").attr("opacity",0).transition().delay(bubbleDelay+1800).duration(2500).ease("cube").style("opacity",.9)}function renderBubbles(){var t=g.selectAll("circle").data(migratedCountry).enter();t.append("circle").attr("class","bubble").attr("cx",function(t){return projection([deathById.get(t.id).Longitude,deathById.get(t.id).Latitude])[0]}).attr("cy",function(t){return projection([deathById.get(t.id).Longitude,deathById.get(t.id).Latitude])[1]}).attr("r",0).on("mouseover",function(t){d3.select(this).classed("selected",!0),tooltip.transition().duration(100).style("opacity",1),d3.event.pageX>width-200?tooltip.style("left",d3.event.pageX-210+"px"):tooltip.style("left",d3.event.pageX+20+"px").style("top",d3.event.pageY-30+"px"),d3.event.pageY>height-150?tooltip.style("top",d3.event.pageY-140+"px"):tooltip.style("top",d3.event.pageY-30+"px");var e="s";1==deathById.get(t.id)[CURR_SELECT[0]]&&(e=""),tooltip.select("#number").text(deathById.get(t.id)[CURR_SELECT[0]]),tooltip.select("#text").text(" worker"+e+" died "+deathType.toLowerCase()+" in "),tooltip.select("#name").text(t.country),tooltip.select("#period1").text("2067-68 : "),tooltip.select("#period2").text("2068-69 : "),tooltip.select("#period3").text("2069-70 : "),tooltip.select("#period4").text("2070-71 : "),tooltip.select("#period5").text("2071-** : "),tooltip.select(".num1").text(deathById.get(t.id)[CURR_BAR[0]+"_067_068"]),tooltip.select(".num2").text(deathById.get(t.id)[CURR_BAR[0]+"_068_069"]),tooltip.select(".num3").text(deathById.get(t.id)[CURR_BAR[0]+"_069_070"]),tooltip.select(".num4").text(deathById.get(t.id)[CURR_BAR[0]+"_070_071"]),tooltip.select(".num5").text(deathById.get(t.id)[CURR_BAR[0]+"_071_071"]+" ( est. "+deathById.get(t.id)[CURR_BAR[0]+"_071_071_Forecast"]+")"),d3.select(this).transition().duration(100).style("fill-opacity",.8).style("stroke","#000")}).on("mouseout",function(){d3.select(this).classed("selected",!1),tooltip.transition().duration(300).style("opacity",0),d3.select(this).transition().duration(50).style("fill-opacity",.7).style("stroke","#fff")}).transition().delay(bubbleDelay).duration(600).attr("r",function(t){return deathById.get(t.id)[CURR_SELECT[0]]>0?radius(deathById.get(t.id)[CURR_SELECT[0]]):0}).style("fill",function(){return"#ee4000"})}function arcHandler(){var t=g.append("path").datum({type:"LineString",coordinates:[[85.30014,27.700769],[102.538116,3.519863]]});drawArcs(t),t=g.append("path").datum({type:"LineString",coordinates:[[85.30014,27.700769],[127.766922,35.907757]]}),drawArcs(t),t=g.append("path").datum({type:"LineString",coordinates:[[85.30014,27.700769],[140.252924,39.004824]]}),drawArcs(t),t=g.append("path").datum({type:"LineString",coordinates:[[85.30014,27.700769],[69.160652,34.543896]]}),drawArcs(t),t=g.append("path").datum({type:"LineString",coordinates:[[85.30014,27.700769],[41.079162,25.485942]]}),drawArcs(t),t=g.append("path").datum({type:"LineString",coordinates:[[85.30014,27.700769],[51.183884,24.824826]]}),drawArcs(t),t=g.append("path").datum({type:"LineString",coordinates:[[85.30014,27.700769],[54.966667,24.466667]]}),drawArcs(t),t=g.append("path").datum({type:"LineString",coordinates:[[85.30014,27.700769],[34.851612,31.046051]]}),drawArcs(t),t=g.append("path").datum({type:"LineString",coordinates:[[85.30014,27.700769],[47.481766,29.31166]]}),drawArcs(t),t=g.append("path").datum({type:"LineString",coordinates:[[85.30014,27.700769],[50.5577,26.0667]]}),drawArcs(t),t=g.append("path").datum({type:"LineString",coordinates:[[85.30014,27.700769],[35.862285,33.854721]]}),drawArcs(t),t=g.append("path").datum({type:"LineString",coordinates:[[85.30014,27.700769],[58.54,22.61]]}),drawArcs(t)}function drawArcs(t){return t.attr("class","route").attr("d",path).transition().delay(100).style("fill",function(){var t=this.getTotalLength();return this.style.transition=this.style.WebkitTransition="none",this.style.strokeDasharray=t+" "+t,this.style.strokeDashoffset=t,this.getBoundingClientRect(),this.style.transition=this.style.WebkitTransition="stroke-dashoffset "+animationSpeed+"ms ease-out",this.style.strokeDashoffset="0","none"})}var width=960,mapRatio=.62,height=width*mapRatio,animationSpeed=1200,bubbleDelay=800,deathType="in total",deathById=d3.map(),CURR_SELECT=["Country_Total"],CURR_BAR=["Total"],years=["2067-68","2068-69","2069-70","2070-71","2071-**"],migratedCountry=[{id:"MYS",country:"Malaysia"},{id:"KOR",country:"South Korea"},{id:"JPN",country:"Japan"},{id:"AFG",country:"Afghanistan"},{id:"QAT",country:"Qatar"},{id:"SAU",country:"Saudi Arabia"},{id:"BHR",country:"Bahrain"},{id:"ARE",country:"United Arab Emirates"},{id:"KWT",country:"Kuwait"},{id:"ISR",country:"Israel"},{id:"LBN",country:"Lebanon"},{id:"OMN",country:"Oman"}],radius=d3.scale.sqrt().domain([1,1300]).range([1,40]),color=d3.scale.sqrt().domain([1,1300]).range(["#feb24c","#ff0000"]).interpolate(d3.interpolateLab),projection=d3.geo.equirectangular().center([100,17]).rotate([9.6,0]).precision(.1),path=d3.geo.path().projection(projection),svg=d3.select("body #map").append("svg").attr("width",width).attr("height",height);svg.append("svg:image").attr("xlink:href","images/progress-anim.gif").attr("id","progress-image").attr("width",43).attr("height",11).attr("x",width/2).attr("y",height/2-100);var g=svg.append("g"),tooltip=d3.select("#tooltip").attr("class","tooltip").style("opacity",0);queue().defer(d3.json,"data/asia.topo.json").defer(d3.csv,"data/deaths.csv",setColumns).await(ready);